(defconstant MAIN_HELIX_VELOCITY 100.0)
(defconstant TAIL_HELIX_VELOCITY 100.0)
(defconstant WEIGHT_FORCE 16.6555161)
(defconstant TARGET_ALTITUDE 2.0)
(defconstant LABEL_X 0.75)
(defconstant LABEL_Y 0.05)
(defconstant RED #xFF0000)

(defun main ()
  (wb_robot_init);
  (setq time_step (wb_robot_get_basic_time_step))
  (setq gps (wb_robot_get_device "gps"))
  (setq inertial_unit (wb_robot_get_device "inertial unit"))
  (wb_gps_enable gps time_step)
  (wb_inertial_unit_enable inertial_unit time_step)
  (setq main_motor (wb_robot_get_device "main_motor"))
  (setq tail_motor (wb_robot_get_device "tail_motor"))
  (wb_motor_set_position main_motor INFINITY)
  (wb_motor_set_position tail_motor INFINITY)
  (wb_motor_set_velocity main_motor (+ MAIN_HELIX_VELOCITY 1))
  (wb_motor_set_velocity tail_motor TAIL_HELIX_VELOCITY)

  (while (> (wb_robot_step time_step) 0)
    (setq altitude (cout-float-vector (wb_gps_get_values gps) 1))
    (setq yaw (cout-float-vector (wb_inertial_unit_get_roll_pitch_yaw inertial_unit) 2))
    (setq buffer (format nil "Altitude: ~1.1f m" altitude))
    (wb_supervisor_set_label 0 buffer LABEL_X LABEL_Y 0.07 RED 0 "Arial")
    (setq buffer (format nil "Yaw: ~1.1f rad" yaw))
    (wb_supervisor_set_label 1 buffer LABEL_X (- LABEL_Y 0.03) 0.07 RED 0 "Arial")
    (setq ratio (- 1.0 (/ altitude TARGET_ALTITUDE)))
    (wb_motor_set_velocity main_motor (+ MAIN_HELIX_VELOCITY ratio))
    )
  )
(main)
