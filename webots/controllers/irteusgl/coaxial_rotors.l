;;;
;;;
(defconstant HELIX_VELOCITY 100.0)
(defconstant WEIGHT_FORCE 16.3465011)
(defconstant TARGET_ALTITUDE 2.0)
(defconstant LABEL_X 0.05)
(defconstant LABEL_Y 0.95)
(defconstant GREEN #x008800)
(setq *init* nil)
(defun main-init ()
  (wb_robot_init)
  (setq time_step (wb_robot_get_basic_time_step))
  (setq gps (wb_robot_get_device "gps"))
  (setq inertial_unit (wb_robot_get_device "inertial unit"))
  (wb_gps_enable gps time_step)
  (wb_inertial_unit_enable inertial_unit time_step)
  (setq upper_motor (wb_robot_get_device "upper_motor"))
  (setq lower_motor (wb_robot_get_device "lower_motor"))
  (setq tail_motor (wb_robot_get_device "tail_motor"))
  (wb_motor_set_position upper_motor INFINITY)
  (wb_motor_set_position lower_motor INFINITY)
  (wb_motor_set_position tail_motor INFINITY)
  (setq velocity (+ HELIX_VELOCITY 1.0))
  (wb_motor_set_velocity upper_motor (- velocity))
  (wb_motor_set_velocity lower_motor velocity)
  (wb_motor_set_velocity tail_motor 15.0)
  (setq *init* t))

(defun main nil
  (unless *init* (main-init))
  (do-until-key (main-step)))

(defun main-step nil
  (setq altitude (cout-float-vector (wb_gps_get_values gps) 1))
  (setq yaw (cout-float-vector (wb_inertial_unit_get_roll_pitch_yaw inertial_unit) 2))
  (setq buffer (format nil "Altitude: ~1.1f m" altitude))
  (wb_supervisor_set_label 5 buffer LABEL_X LABEL_Y 0.07 GREEN 0 "Arial")
  (setq buffer (format nil "Yaw: ~1.1f rad" yaw))
  (wb_supervisor_set_label 6 buffer LABEL_X (- LABEL_Y 0.03) 0.07 GREEN 0 "Arial")
  (setq ratio (- 1.0 (/ altitude TARGET_ALTITUDE)))
  (setq velocity (+ HELIX_VELOCITY ratio))
  (wb_motor_set_velocity upper_motor (- velocity))
  (wb_motor_set_velocity lower_motor velocity)
  )
(defun itimer-on nil
  (unless *init* (main-init))
  (setq *top-selector-interval* 0.01)
  (pushnew 'main-step *timer-job*))
(defun itimer-off nil
  (setq *timer-job* (remove 'main-step *timer-job*)))
;;(main)
;;(itimer-on)
